<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <link rel="canonical" href="https://osg-htc.org/user-school-2019/materials/day5/part1-ex1-science-intro/">
    <link rel="shortcut icon" href="../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Exercise 1.1 - OSG User School 2019</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <link href="../../../css/extra.css" rel="stylesheet">
    <link href="../../../css/codehilite.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Friday Exercise 1.1: Learn about Joe's Desired Computing Work", url: "#_top", children: [
              {title: "Joe's Science and Workflow", url: "#joes-science-and-workflow" },
              {title: "Joe's Current Setup", url: "#joes-current-setup" },
              {title: "View Joe's files", url: "#view-joes-files" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    <style type="text/css"> pre em { font-style: normal; background-color: yellow; } pre strong { font-style: normal; font-weight: bold; color: \#008; } </style>

<h1 id="friday-exercise-11-learn-about-joes-desired-computing-work">Friday Exercise 1.1: Learn about Joe's Desired Computing Work<a class="headerlink" href="#friday-exercise-11-learn-about-joes-desired-computing-work" title="Permanent link">&para;</a></h1>
<p>In today's set of hands-on exercises, you'll be examining a set of pre-existing job submissions (scripts and submit files) and then coordinating them to run as a single workflow using a DAG. Along the way, you'll need to test some of the already written submit files. The first part of this exercise introduces the overall steps for the workflow and what pieces already exist (that you won't need to write yourself).</p>
<h2 id="joes-science-and-workflow">Joe's Science and Workflow<a class="headerlink" href="#joes-science-and-workflow" title="Permanent link">&para;</a></h2>
<p>Joe Biologist studies the influence of genetic differences (genotypes) on the growth traits (phenotypes) of a common crop. He has come to you with some computing work he’d like to automate as a workflow, so that he can scale out his research and run it on a much larger HTC compute system. </p>
<p>Joe starts with a spreadsheet containing phenotype measurements and genotype information for hundreds of plants.  Each phenotype measurement corresponds to a trait that he's interested in learning about.  In order to understand the relationship of these trait phenotypes to the underlying genetic material (the genotypes), he first generates thousands of combinations of the trait's phenotype with all the genotypes.  These <strong>permutations</strong> represent hypothetical phenotype-genotype connections that could be meaningful for that trait.  Each of these permutations is then run through a <strong>QTL mapping</strong> process, which sifts through all the permutations to find the genotypes that are most important for the trait in question.  Joe has to repeat this process (generating genotype-phenotype permutations and then running a QTL mapping on those permutations) separately for each trait he's studying.  </p>
<h2 id="joes-current-setup">Joe's Current Setup<a class="headerlink" href="#joes-current-setup" title="Permanent link">&para;</a></h2>
<p>Joe has run some of this work on a high throughput system -- submitting individual jobs on a small, dedicated HTCondor cluster where he doesn’t have to request CPU, disk, or RAM.  </p>
<p>(As you learn more details below, it might be helpful to draw a diagram that describes the steps of his workflow.)</p>
<p>Specifically, for one trait, his workflow looks like this: </p>
<ol>
<li>Uploading an input file (<code>input.csv</code>) to the submit server that has <em>all</em> of the genotypic and phenotypic information for multiple traits.  </li>
<li>Joe then uses a submit file, perl wrapper script (<code>runR.pl</code>) and custom R script (<code>run_perm.R</code>) to submit jobs that generate the permutations for a single trait.  The perl script is the job's executable.  Besides setting up the job environment, it takes several arguments: <ul>
<li>The name of the R script that creates the permutations</li>
<li>Which trait (and therefore which phenotype) it's using to create permutations</li>
<li>How many permutations to create per job</li>
<li>When running multiple permutation jobs at once for a trait, a number to identify the job. </li>
</ul>
</li>
<li>After the permutation job(s), a shell script creates a tarball of the permutation files for that trait (which may have been generated by multiple jobs).  This is a short-running script that runs directly on the submit server.  </li>
<li>The second job (the QTL mapping step) uses the tarball of trait permutations from the previous step, the same perl wrapper script (<code>runR.pl</code>), and a different R script (<code>run_qtl.R</code>) to run the QTL mapping on the permutations generated in the first batch of jobs.  </li>
<li>Finally, a second shell script creates a tarball of the QTL mapping output on the submit server.   </li>
</ol>
<p>He has to perform all of these steps for each trait he wants to analyze.  </p>
<p>That's a lot of steps!  Joe Biologist is getting annoyed by how many manual job submissions and summary scripts he has to run, especially as he's thinking of scaling out his work in a way that would be much more cumbersome.  As one example, when Joe has previously run the <strong>permutation</strong> step (generating 10,000 permutations for a single trait) as one Condor job on his own cluster, the job runs for hours.  To solve that problem in the past, he split the single permutation-creating Condor job into multiple, shorter Condor jobs, each creating fewer permutations, but he doesn’t remember the details of how many jobs and how many permutations per job worked well. Furthermore, Joe would like to scale up to 100,000 permutations (from 10,000) per trait this time.   Unlike the <strong>permutation</strong> step, the <strong>QTL</strong> step finishes quite quickly; even with 10,000 permutations completed for each trait, the <strong>QTL</strong> step completes within several minutes.</p>
<p>Joe knows that he needs to modify and optimize his submissions to run jobs that create more permutations and that DAGMan might help him automate all these steps.  He's never used DAGMan, so he's asking you to help him organize all the steps into an optimized DAG workflow.</p>
<h2 id="view-joes-files">View Joe's files<a class="headerlink" href="#view-joes-files" title="Permanent link">&para;</a></h2>
<p><strong>(but don't do anything with them until the next <a href="../part1-ex2-plan-workflow/">exercise</a>, where you'll plan necessary developments of a workflow for Joe.)</strong></p>
<p>Log in to <code>learn.chtc.wisc.edu</code> and move to a desired location in your home directory. Enter the following commands to download and decompress/untar Joe’s job ingredients:</p>
<div class="codehilite"><pre><span></span><span class="gp">username@learn $</span> wget http://proxy.chtc.wisc.edu/SQUID/osgschool19/WorkflowExercise.tar.gz
<span class="gp">username@learn $</span> tar -xzf WorkflowExercise.tar.gz
</pre></div>


<p>You can now navigate into the <code>WorkflowExercise</code> directory to view the full ingredients for Joe’s Computing work. Review all of these files based upon the information below and refer back to it as you proceed through the remaining exercises (1.2, 2.1, 2.2). (If you've been drawing a diagram of Joe's work so far, feel free to annotate with some of this information.)</p>
<p>Based upon Joe’s description and submit files you determine the following details for analyzing <strong>trait 1</strong>: </p>
<h3 id="permutation-step">Permutation Step<a class="headerlink" href="#permutation-step" title="Permanent link">&para;</a></h3>
<p>The command the job should run: <code>./runR.pl 1_$(Process) run_perm.R 1 $(Process) 10000</code></p>
<p>The submit file for the permutation jobs is <code>permutation1.submit</code>, including the following: </p>
<div class="codehilite"><pre><span></span>executable = runR.pl
arguments = 1_$(Process) run_perm.R 1 $(Process) 10000
transfer_input_files = run_perm.R, input.csv, RLIBS.tar.gz
</pre></div>


<p>The arguments mean the following:</p>
<ul>
<li><code>1_$(Process)</code>, used by <code>runR.pl</code> to name its log file</li>
<li><code>run_perm.R</code>, which R script we want to run</li>
<li><code>1</code>, trait column in <code>input.csv</code></li>
<li><code>$(Process)</code>, used by <code>run_perm.R</code> for naming the permutation output</li>
<li><code>10000</code>, indicates that 10,000 permutations should be done for each individual job process.  If we use this submit file to create multiple jobs, each of them will create 10,000 permutations.  </li>
</ul>
<p>As output, this job will create:</p>
<ul>
<li>a series of .log and .out files, named from the first argument (<code>1_$(Process)</code>). This looks like: <code>runR.1_0.out</code>, <code>runR.1_0.log</code>, <code>runR.1_0.err</code></li>
<li>the actual output file, named using the <code>1</code> and <code>$(Process)</code> arguments, like so: <code>perm_part.1_0.Rdat</code></li>
</ul>
<h3 id="combine-permutation-output">Combine Permutation Output<a class="headerlink" href="#combine-permutation-output" title="Permanent link">&para;</a></h3>
<p><code>tarit.sh</code> is run after the trait's <strong>permutation</strong> step with the column number as an argument to compress <code>perm_part.1_0.Rdat</code> (or potentially multiple such files named according to <code>perm_part.1_*.Rdat</code>, see above) for the QTL step.</p>
<p>Sample execution: </p>
<div class="codehilite"><pre><span></span><span class="gp">username@host $</span> ./tarit.sh <span class="m">1</span>
</pre></div>


<p>where <code>1</code> is the trait column number.</p>
<h3 id="qtl-mapping-step">QTL Mapping Step<a class="headerlink" href="#qtl-mapping-step" title="Permanent link">&para;</a></h3>
<p>The command the job should run: <code>./runR.pl qtl_1 qtl.R 1</code></p>
<p>The submit file for the permutation jobs is <code>qtl1.submit</code>, containing the following: </p>
<div class="codehilite"><pre><span></span>executable = runR.pl
arguments qtl_1 qtl.R 1
transfer_input_files = qtl.R, input.csv, RLIBS.tar.gz, perm_combined_1.tar.gz
</pre></div>


<p>Note that <code>perm_combined_1.tar.gz</code> was created by <code>tarit.sh</code>.</p>
<p>The arguments mean the following:</p>
<ul>
<li><code>qtl_1</code>: used by <code>runR.pl</code> to name its log / output / error files</li>
<li><code>qtl.R</code>: which R script we want to run</li>
<li><code>1</code>: trait column in <code>input.csv</code>, will also be used to name the output files</li>
</ul>
<p>As output, this job will create:</p>
<ul>
<li>a series of .log and .out files, named from the first argument (<code>qtl_1</code>).</li>
<li>several output files named for the trait argument <code>1</code>: <code>perm_combined_1.Rdat</code>, <code>perm_summary_1.txt</code>, <code>sim_geno_results_1.Rdat</code>, <code>qtl_1.Rdat</code>, <code>refined_qtl_summary_1.txt</code>, <code>refined qtl_1.Rdat</code>, and <code>fit_qtl_results_1.Rdat</code></li>
</ul>
<h3 id="combine-all-output">Combine All Output<a class="headerlink" href="#combine-all-output" title="Permanent link">&para;</a></h3>
<p><code>results_1.tar.gz</code> is made by running <code>taritall.sh</code> with the column number as an argument after the QTL step for that trait finishes, where "1" reflects the trait column number in the output above.</p>
<p>Sample execution: </p>
<div class="codehilite"><pre><span></span><span class="gp">username@host $</span> ./taritall.sh <span class="m">1</span>
</pre></div>


<p>where <code>1</code> is the trait column number.</p>
<h3 id="other-files">Other Files<a class="headerlink" href="#other-files" title="Permanent link">&para;</a></h3>
<p>The other files in the workflow directory (<code>permutation2.submit</code>/<code>qtl2.submit</code> and <code>permutation3.submit</code>/<code>qtl3.submit</code>) are used to submit the <strong>permutation</strong> and <strong>qtl</strong> jobs for traits 2 and 3, respectively.  </p>

  <br>
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../part1-ex2-plan-workflow/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../part1-ex2-plan-workflow/" class="btn btn-xs btn-link">
        Exercise 1.2
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../day4/part4-ex5-challenges/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../day4/part4-ex5-challenges/" class="btn btn-xs btn-link">
        Bonus Exercises 4.5
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content">
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>